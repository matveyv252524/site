<!DOCTYPE html>
<html>
<head>
    <title>–ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫</title>
    <style>
        :root {
            --primary-color: #1da1f2;
            --error-color: #e0245e;
            --background: #f5f8fa;
            --white: #ffffff;
            --text-color: #14171a;
            --light-text: #657786;
            --border-color: #e6ecf0;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--background);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .call-container {
            width: 400px;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .call-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .call-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .call-id {
            color: var(--light-text);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .call-user {
            font-weight: bold;
            color: var(--primary-color);
        }

        .call-status {
            margin: 20px 0;
            color: var(--light-text);
            font-size: 16px;
            text-align: center;
        }

        .audio-indicator {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

        .mute-btn {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .mute-btn:hover {
            background: #f5f5f5;
        }

        .end-call-btn {
            background: var(--error-color);
            color: white;
        }

        .end-call-btn:hover {
            background: #c51a4a;
        }

        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            background: var(--error-color);
            color: white;
        }

        .connected #connection-status {
            background: #17bf63;
        }
    </style>
</head>
<body>
    <div id="connection-status">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>

    <div class="call-container">
        <div class="call-header">
            <div class="call-title">–ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫</div>
            <div class="call-id">ID: {{ call_id }}</div>
            <div>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å: <span class="call-user">{{ call_id.split('_')[1] }}</span></div>
        </div>

        <div class="call-status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

        <div class="audio-indicator">
            <span id="audio-icon">üîä</span>
        </div>

        <div class="call-controls">
            <button id="toggleAudio" class="control-btn mute-btn" title="–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">üé§</button>
            <button id="endCall" class="control-btn end-call-btn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>
    <audio id="localAudio" muted style="display: none;"></audio>

    <script>
        const callId = "{{ call_id }}";
        const userId = "{{ user_id }}";
        const otherUserId = callId.split('_')[0] === userId ? callId.split('_')[1] : callId.split('_')[0];
        let peerConnection;
        let localStream;
        let isCaller = callId.startsWith(userId + '_');
        let isMuted = false;

        // WebSocket connection
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const ws = new WebSocket(`${protocol}${window.location.host}/ws/${userId}`);

        function updateStatus(status) {
            const statusElement = document.getElementById("connection-status");
            statusElement.textContent = status;

            if (status === "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ") {
                document.body.classList.add('connected');
            } else {
                document.body.classList.remove('connected');
            }
        }

        ws.onopen = () => {
            updateStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
            startCall();
        };

        ws.onclose = () => {
            updateStatus("–û—Ç–∫–ª—é—á–µ–Ω–æ");
            endCall();
        };

        ws.onerror = (error) => {
            console.error("–û—à–∏–±–∫–∞ WebSocket:", error);
            updateStatus("–û—à–∏–±–∫–∞");
        };

        async function setupAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1
                    },
                    video: false
                });

                const localAudio = document.getElementById('localAudio');
                localAudio.srcObject = localStream;

                document.getElementById("status").textContent = "–ê—É–¥–∏–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ";
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", error);
                document.getElementById("status").textContent = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω";
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.");
                endCall();
                throw error;
            }
        }

        function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    { urls: "stun:stun1.l.google.com:19302" },
                    { urls: "stun:stun2.l.google.com:19302" }
                ]
            };

            peerConnection = new RTCPeerConnection(configuration);

            // Add audio tracks
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // ICE candidate handlers
            peerConnection.onicecandidate = ({ candidate }) => {
                if (candidate) {
                    ws.send(JSON.stringify({
                        type: "ice_candidate",
                        from: userId,
                        to: otherUserId,
                        call_id: callId,
                        candidate: candidate.toJSON()
                    }));
                }
            };

            // Handle remote stream
            peerConnection.ontrack = ({ streams: [remoteStream] }) => {
                const remoteAudio = document.getElementById("remoteAudio");
                if (!remoteAudio.srcObject) {
                    remoteAudio.srcObject = remoteStream;
                    document.getElementById("status").textContent = "–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω";

                    remoteAudio.play().catch(e => console.log("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", e));
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                if (state === "disconnected" || state === "failed") {
                    endCall();
                }
            };
        }

        async function startCall() {
            try {
                await setupAudio();
                createPeerConnection();

                if (isCaller) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);

                    ws.send(JSON.stringify({
                        type: "webrtc_offer",
                        from: userId,
                        to: otherUserId,
                        call_id: callId,
                        offer: peerConnection.localDescription.toJSON(),
                        is_audio_only: true
                    }));
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:", error);
                endCall();
            }
        }

        // WebSocket message handler
        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "webrtc_offer" && !isCaller) {
                try {
                    await setupAudio();
                    createPeerConnection();

                    await peerConnection.setRemoteDescription(
                        new RTCSessionDescription(data.offer)
                    );

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    ws.send(JSON.stringify({
                        type: "webrtc_answer",
                        from: userId,
                        to: data.from,
                        call_id: callId,
                        answer: peerConnection.localDescription.toJSON()
                    }));
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ñ–µ—Ä–∞:", error);
                    endCall();
                }
            }
            else if (data.type === "webrtc_answer" && isCaller) {
                try {
                    await peerConnection.setRemoteDescription(
                        new RTCSessionDescription(data.answer)
                    );
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞:", error);
                    endCall();
                }
            }
            else if (data.type === "ice_candidate") {
                try {
                    if (data.candidate) {
                        await peerConnection.addIceCandidate(
                            new RTCIceCandidate(data.candidate)
                        );
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:", error);
                }
            }
        };

        // Call controls
        document.getElementById("endCall").addEventListener("click", endCall);
        document.getElementById("toggleAudio").addEventListener("click", toggleAudio);

        function toggleAudio() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                isMuted = !audioTracks[0].enabled;
                audioTracks.forEach(track => track.enabled = !isMuted);

                const icon = document.getElementById("audio-icon");
                icon.textContent = isMuted ? "üîá" : "üîä";

                const btn = document.getElementById("toggleAudio");
                btn.title = isMuted ? "–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫" : "–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫";
            }
        }

        function endCall() {
            // Send call end notification
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "call_end",
                    from: userId,
                    to: otherUserId,
                    call_id: callId
                }));
            }

            // Close connections
            if (peerConnection) {
                peerConnection.close();
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            if (ws.readyState === WebSocket.OPEN) {
                ws.close();
            }

            // Return to chat
            window.location.href = `/chat/${userId}`;
        }

        // Handle page close
        window.addEventListener('beforeunload', endCall);
        window.addEventListener('pagehide', endCall);
    </script>
</body>
</html>
