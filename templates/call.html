<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - FastAPI Messenger</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        body {
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #4285f4;
            color: white;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        header h1 {
            text-align: center;
        }
        .btn {
            display: inline-block;
            background: #4285f4;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .call-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        video {
            width: 100%;
            max-width: 500px;
            height: auto;
            max-height: 300px;
            background: #000;
            border-radius: 8px;
        }
        .call-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        #localVideo {
            transform: scaleX(-1); /* Зеркальное отображение для локального видео */
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>FastAPI Messenger - Video Call</h1>
        </div>
    </header>
    <div class="container">
        <div class="call-container">
            <h2>Call ID: {{ call_id }}</h2>

            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>

            <div class="call-controls">
                <button id="endCall" class="btn btn-danger">End Call</button>
                <button id="toggleAudio" class="btn">Mute</button>
                <button id="toggleVideo" class="btn">Hide Video</button>
            </div>
        </div>
    </div>

    <script>
        const callId = "{{ call_id }}";
        const userId = callId.split('_')[0];
        let peerConnection;
        let localStream;
        let isAudioMuted = false;
        let isVideoHidden = false;

        // WebSocket соединение
        const ws = new WebSocket(`ws://${window.location.host}/ws/${userId}`);

        // Элементы интерфейса
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const endCallBtn = document.getElementById('endCall');
        const toggleAudioBtn = document.getElementById('toggleAudio');
        const toggleVideoBtn = document.getElementById('toggleVideo');

        // Конфигурация ICE-серверов
        const configuration = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" }
            ]
        };

        // Инициализация звонка
        async function initCall() {
            try {
                // Получаем медиапоток
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                localVideo.srcObject = localStream;

                // Создаем RTCPeerConnection
                peerConnection = new RTCPeerConnection(configuration);

                // Добавляем треки в соединение
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Обработчики событий ICE
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        const otherUserId = callId.split('_')[0] === userId ?
                                            callId.split('_')[1] : callId.split('_')[0];
                        ws.send(JSON.stringify({
                            type: "ice_candidate",
                            to: otherUserId,
                            call_id: callId,
                            candidate: event.candidate
                        }));
                    }
                };

                peerConnection.ontrack = event => {
                    remoteVideo.srcObject = event.streams[0];
                };

                // Если мы инициатор звонка, создаем offer
                if (callId.startsWith(userId + '_')) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);

                    ws.send(JSON.stringify({
                        type: "offer",
                        to: callId.split('_')[1],
                        call_id: callId,
                        offer: offer
                    }));
                } else {
                    // Если мы получатель, ждем offer
                    const offer = await waitForOffer();
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    ws.send(JSON.stringify({
                        type: "answer",
                        to: callId.split('_')[0],
                        call_id: callId,
                        answer: answer
                    }));
                }

                // Управление аудио/видео
                toggleAudioBtn.addEventListener('click', toggleAudio);
                toggleVideoBtn.addEventListener('click', toggleVideo);

            } catch (error) {
                console.error("Error initializing call:", error);
                alert("Failed to initialize call. Please check your camera/microphone permissions.");
                endCall();
            }
        }

        // Ожидание offer от другого пользователя
        function waitForOffer() {
            return new Promise((resolve) => {
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === "offer" && data.call_id === callId) {
                        resolve(data.offer);
                    }
                };
            });
        }

        // Обработчик сообщений WebSocket
        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "call_answer" && data.call_id === callId) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
            else if (data.type === "ice_candidate" && data.call_id === callId) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (e) {
                    console.error("Error adding ICE candidate:", e);
                }
            }
        };

        // Переключение аудио
        function toggleAudio() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isAudioMuted = !isAudioMuted;
                toggleAudioBtn.textContent = isAudioMuted ? "Unmute" : "Mute";
            }
        }

        // Переключение видео
        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isVideoHidden = !isVideoHidden;
                toggleVideoBtn.textContent = isVideoHidden ? "Show Video" : "Hide Video";
            }
        }

        // Завершение звонка
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            window.location.href = `/chat/${userId}`;
        }

        endCallBtn.addEventListener('click', endCall);

        // Инициализация при загрузке страницы
        initCall();
    </script>
</body>
</html>