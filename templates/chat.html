<!DOCTYPE html>
<html>
<head>
    <title>Аудио чат</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .contact {
            padding: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .contact:hover {
            background: #e9ecef;
        }
        .contact.active {
            background: #dee2e6;
        }
        #messages {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            background: white;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            max-width: 70%;
        }
        .received {
            background: #e3f2fd;
            text-align: left;
        }
        .sent {
            background: #bbdefb;
            text-align: right;
            margin-left: auto;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }
        #message-form {
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            background: #f44336;
            color: white;
        }
        .connected #connection-status {
            background: #4CAF50;
        }
        #new-contact-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        #new-contact-modal input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #user-info {
            padding: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .call-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4285f4;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        .call-waiting {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="user-info">
            <h3>{{ username }}</h3>
            <a href="/logout" style="color: #f44336; text-decoration: none;">Выйти</a>
        </div>

        <div id="contacts-header">
            <h3>Контакты</h3>
            <button onclick="showNewContactModal()">+ Добавить</button>
        </div>

        <div id="contacts-list">
            {% for contact in contacts %}
            <div class="contact" onclick="selectContact('{{ contact.id }}', '{{ contact.username }}')">
                {{ contact.username }}
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="chat-container">
        <div id="connection-status">Отключено</div>

        <h3 id="current-contact">Выберите контакт для чата</h3>
        <div id="messages"></div>

        <div id="message-form">
            <input type="text" id="message-input" placeholder="Введите сообщение..." disabled>
            <button onclick="sendMessage()" disabled id="send-btn">Отправить</button>
            <button onclick="startAudioCall()" disabled id="call-btn">Аудио звонок</button>
        </div>
    </div>

    <div id="new-contact-modal">
        <h3>Добавить новый контакт</h3>
        <input type="text" id="contact-username" placeholder="Введите имя (например, #username)">
        <div style="display: flex; gap: 10px;">
            <button onclick="addContact()">Добавить</button>
            <button onclick="hideNewContactModal()" style="background: #f44336;">Отмена</button>
        </div>
    </div>

    <div id="waiting-notification" class="call-waiting" style="display: none;">
        Ожидание ответа...
        <button onclick="cancelCall()" style="margin-left: 10px; background: #f44336;">Отмена</button>
    </div>

    <script>
        const userId = "{{ user_id }}";
        const username = "{{ username }}";
        let ws;
        let currentContact = null;
        let currentCallId = null;
        let callTimeout;

        function updateStatus(status) {
            const statusElement = document.getElementById("connection-status");
            statusElement.textContent = status;
            statusElement.style.background = status === "Подключено" ? "#4CAF50" : "#f44336";
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            ws = new WebSocket(`${protocol}${window.location.host}/ws/${userId}`);

            ws.onopen = () => {
                updateStatus("Подключено");
                console.log("WebSocket подключен");
            };

            ws.onclose = () => {
                updateStatus("Отключено");
                console.log("WebSocket отключен, переподключение...");
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error("Ошибка WebSocket:", error);
                updateStatus("Ошибка");
            };

            ws.onmessage = (event) => {
                console.log("Получено сообщение WebSocket:", event.data);
                const data = JSON.parse(event.data);

                if (data.type === "message") {
                    // Проверяем, относится ли сообщение к текущему чату
                    const isCurrentChat = (data.from === currentContact || data.from === userId);
                    if (isCurrentChat) {
                        displayMessage(data.from === userId ? username : data.from, 
                                       data.message, 
                                       data.from !== userId, 
                                       data.timestamp);
                    }
                }
                else if (data.type === "call_incoming") {
                    showIncomingCall(data.from, data.call_id);
                }
                else if (data.type === "call_waiting") {
                    showWaitingNotification(data.call_id);
                }
                else if (data.type === "call_accepted") {
                    handleCallAccepted(data.call_id);
                }
                else if (data.type === "call_rejected") {
                    handleCallRejected(data.by);
                }
            };
        }

        function selectContact(contactId, contactName) {
            currentContact = contactId;
            document.getElementById("current-contact").textContent = `Чат с ${contactName}`;
            document.getElementById("message-input").disabled = false;
            document.getElementById("send-btn").disabled = false;
            document.getElementById("call-btn").disabled = false;

            // Удаляем активный класс у всех контактов
            document.querySelectorAll('.contact').forEach(el => {
                el.classList.remove('active');
            });

            // Добавляем активный класс выбранному контакту
            event.target.classList.add('active');

            // Очищаем сообщения и загружаем историю чата
            document.getElementById("messages").innerHTML = "";
            loadMessageHistory(contactId);
        }

        async function loadMessageHistory(contactId) {
            try {
                const response = await fetch(`/get-messages?user_id=${userId}&contact_id=${contactId}`);
                const messages = await response.json();

                messages.forEach(msg => {
                    const isReceived = msg.sender_id != userId;
                    displayMessage(
                        isReceived ? msg.sender_username : username,
                        msg.message,
                        isReceived,
                        msg.timestamp
                    );
                });
            } catch (error) {
                console.error("Ошибка загрузки истории сообщений:", error);
            }
        }

        function showNewContactModal() {
            document.getElementById("new-contact-modal").style.display = 'block';
        }

        function hideNewContactModal() {
            document.getElementById("new-contact-modal").style.display = 'none';
        }

        async function addContact() {
            const contactUsername = document.getElementById("contact-username").value.trim();
            if (!contactUsername) return;

            try {
                const response = await fetch('/add-contact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        contact_username: contactUsername
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Обновляем список контактов
                    const contactsList = document.getElementById("contacts-list");
                    const newContact = document.createElement('div');
                    newContact.className = 'contact';
                    newContact.textContent = result.contact_username;
                    newContact.onclick = function() {
                        selectContact(result.contact_id, result.contact_username);
                    };
                    contactsList.appendChild(newContact);

                    hideNewContactModal();
                } else {
                    alert(result.message || "Не удалось добавить контакт");
                }
            } catch (error) {
                console.error("Ошибка добавления контакта:", error);
                alert("Ошибка добавления контакта");
            }
        }

        function sendMessage() {
            const input = document.getElementById("message-input");
            const message = input.value.trim();

            if (!message || !currentContact) return;

            try {
                ws.send(JSON.stringify({
                    type: "message",
                    to: currentContact,
                    message: message
                }));
                displayMessage(username, message, false, new Date().toISOString());
                input.value = "";
            } catch (e) {
                console.error("Ошибка отправки сообщения:", e);
                alert("Не удалось отправить сообщение");
            }
        }

        function displayMessage(sender, message, isReceived, timestamp) {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${isReceived ? 'received' : 'sent'}`;

            const time = new Date(timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <strong>${sender}:</strong> ${message}
                <div class="timestamp">${time}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function startAudioCall() {
            if (!currentContact) {
                alert("Пожалуйста, выберите контакт сначала");
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("Соединение потеряно. Переподключение...");
                connectWebSocket();
                return;
            }

            ws.send(JSON.stringify({
                type: "call_request",
                to: currentContact,
                is_audio_only: true
            }));
        }

        function showIncomingCall(from, callId) {
            const notification = document.createElement('div');
            notification.className = 'call-notification';
            notification.innerHTML = `
                <h3>Входящий аудио звонок от ${from}</h3>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="acceptCall('${callId}')" style="background: #4CAF50;">Принять</button>
                    <button onclick="rejectCall('${callId}')" style="background: #f44336;">Отклонить</button>
                </div>
            `;
            document.body.appendChild(notification);
        }

        function showWaitingNotification(callId) {
            currentCallId = callId;
            document.getElementById('waiting-notification').style.display = 'block';

            callTimeout = setTimeout(() => {
                alert("Звонок отклонен. Получатель не ответил.");
                hideWaitingNotification();
            }, 30000);
        }

        function hideWaitingNotification() {
            document.getElementById('waiting-notification').style.display = 'none';
            clearTimeout(callTimeout);
        }

        function acceptCall(callId) {
            document.querySelector('.call-notification').remove();
            ws.send(JSON.stringify({
                type: "call_accept",
                call_id: callId
            }));
            window.location.href = `/call/${callId}`;
        }

        function rejectCall(callId) {
            document.querySelector('.call-notification').remove();
            ws.send(JSON.stringify({
                type: "call_reject",
                call_id: callId
            }));
        }

        function cancelCall() {
            if (currentCallId) {
                ws.send(JSON.stringify({
                    type: "call_reject",
                    call_id: currentCallId
                }));
                hideWaitingNotification();
            }
        }

        function handleCallAccepted(callId) {
            hideWaitingNotification();
            window.location.href = `/call/${callId}`;
        }

        function handleCallRejected(by) {
            hideWaitingNotification();
            alert(`${by} отклонил ваш звонок`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();

            document.getElementById("message-input").addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMessage();
            });

            // Проверяем, есть ли контакты, и выбираем первый, если есть
            const contacts = document.querySelectorAll('.contact');
            if (contacts.length > 0) {
                contacts[0].click();
            }
        });
    </script>
</body>
</html>
