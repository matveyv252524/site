<!DOCTYPE html>
<html>
<head>
    <title>Audio Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat-container { display: none; }
        #init-screen { text-align: center; margin-top: 50px; }
        #messages { height: 400px; border: 1px solid #ddd; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
        .received { background: #e3f2fd; text-align: left; }
        .sent { background: #bbdefb; text-align: right; }
        .timestamp { font-size: 0.8em; color: #666; margin-top: 2px; }
        #message-form { display: flex; gap: 10px; }
        #message-input { flex-grow: 1; padding: 8px; }
        button { padding: 8px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            background: #f44336;
            color: white;
        }
        .connected #connection-status {
            background: #4CAF50;
        }
        .call-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4285f4;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        .call-waiting {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
        }
        #contacts-list {
            margin: 20px 0;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .contact-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .contact-item:hover {
            background: #f5f5f5;
        }
        .active-contact {
            background: #e3f2fd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="connection-status">Disconnected</div>

    <div id="init-screen">
        <h2>Audio Messenger</h2>
        <p>Your ID: <strong>{{ user_id }}</strong></p>
        <p>Your username: <strong>{{ username }}</strong></p>

        <div style="margin: 20px 0;">
            <input type="text" id="contact-username" placeholder="Enter friend's username (e.g. #username)">
            <button onclick="addContact()">Add Contact</button>
        </div>

        <div id="contacts-list">
            <h3>Your Contacts</h3>
            {% for contact in contacts %}
                <div class="contact-item" onclick="selectContact('{{ contact.id }}', '{{ contact.username }}')">
                    {{ contact.username }}
                </div>
            {% endfor %}
        </div>
    </div>

    <div id="chat-container">
        <h3>Chat with <span id="contact-name"></span></h3>
        <div id="messages"></div>
        <div id="message-form">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
            <button onclick="startAudioCall()">Audio Call</button>
            <button onclick="backToContacts()">Back to Contacts</button>
        </div>
    </div>

    <div id="waiting-notification" class="call-waiting" style="display: none;">
        Waiting for answer...
        <button onclick="cancelCall()" style="margin-left: 10px; background: #f44336;">Cancel</button>
    </div>

    <script>
        const userId = "{{ user_id }}";
        const username = "{{ username }}";
        let ws;
        let currentContact = null;
        let currentContactName = null;
        let currentCallId = null;
        let callTimeout;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function updateStatus(status) {
            const statusElement = document.getElementById("connection-status");
            statusElement.textContent = status;

            if (status === "Connected") {
                document.body.classList.add('connected');
                statusElement.style.background = "#4CAF50";
            } else {
                document.body.classList.remove('connected');
                statusElement.style.background = "#f44336";
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            ws = new WebSocket(`${protocol}${window.location.host}/ws/${userId}`);

            ws.onopen = () => {
                updateStatus("Connected");
                reconnectAttempts = 0;
                console.log("WebSocket connected");

                if (currentContact) {
                    loadMessages(currentContact);
                }
            };

            ws.onclose = () => {
                updateStatus("Disconnected");
                console.log("WebSocket disconnected");

                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(1000 * (reconnectAttempts + 1), 5000);
                    console.log(`Reconnecting in ${delay}ms...`);
                    setTimeout(connectWebSocket, delay);
                    reconnectAttempts++;
                } else {
                    console.log("Max reconnection attempts reached");
                }
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
                updateStatus("Error");
            };

            ws.onmessage = (event) => {
                console.log("WebSocket message received:", event.data);
                const data = JSON.parse(event.data);

                if (data.type === "message") {
                    displayMessage(data.from, data.message, data.from !== userId, data.timestamp);
                }
                else if (data.type === "call_incoming") {
                    showIncomingCall(data.from, data.call_id, data.is_audio_only);
                }
                else if (data.type === "call_waiting") {
                    showWaitingNotification(data.call_id);
                }
                else if (data.type === "call_accepted") {
                    handleCallAccepted(data.call_id);
                }
                else if (data.type === "call_rejected") {
                    handleCallRejected(data.by);
                }
                else if (data.type === "notification") {
                    alert(data.message);
                }
            };
        }

        function addContact() {
            const contactUsername = document.getElementById("contact-username").value.trim();
            if (!contactUsername) {
                alert("Please enter contact username");
                return;
            }

            fetch('/add-contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    contact_username: contactUsername
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Contact ${data.contact_username} added successfully`);
                    location.reload();
                } else {
                    alert(data.message || "Failed to add contact");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to add contact");
            });
        }

        function selectContact(contactId, contactName) {
            currentContact = contactId;
            currentContactName = contactName;

            document.getElementById("init-screen").style.display = "none";
            document.getElementById("chat-container").style.display = "block";
            document.getElementById("contact-name").textContent = contactName;

            loadMessages(contactId);
        }

        function backToContacts() {
            currentContact = null;
            document.getElementById("chat-container").style.display = "none";
            document.getElementById("init-screen").style.display = "block";
            document.getElementById("messages").innerHTML = "";
        }

        function loadMessages(contactId) {
            fetch(`/get-messages?user_id=${userId}&contact_id=${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    const messagesDiv = document.getElementById("messages");
                    messagesDiv.innerHTML = "";

                    messages.forEach(msg => {
                        displayMessage(
                            msg.sender_id,
                            msg.message,
                            msg.sender_id != userId,
                            msg.timestamp
                        );
                    });
                })
                .catch(error => {
                    console.error("Error loading messages:", error);
                });
        }

        function showIncomingCall(from, callId, isAudioOnly) {
            const notification = document.createElement('div');
            notification.className = 'call-notification';
            notification.innerHTML = `
                <h3>Incoming audio call from ${from}</h3>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="acceptCall('${callId}')" style="background: #4CAF50;">Accept</button>
                    <button onclick="rejectCall('${callId}')" style="background: #f44336;">Reject</button>
                </div>
            `;
            document.body.appendChild(notification);
        }

        function showWaitingNotification(callId) {
            currentCallId = callId;
            document.getElementById('waiting-notification').style.display = 'block';

            callTimeout = setTimeout(() => {
                alert("Call timed out. No answer from recipient.");
                hideWaitingNotification();
            }, 30000);
        }

        function hideWaitingNotification() {
            document.getElementById('waiting-notification').style.display = 'none';
            clearTimeout(callTimeout);
        }

        function acceptCall(callId) {
            document.querySelector('.call-notification').remove();
            ws.send(JSON.stringify({
                type: "call_accept",
                call_id: callId
            }));
            window.location.href = `/call/${callId}`;
        }

        function rejectCall(callId) {
            document.querySelector('.call-notification').remove();
            ws.send(JSON.stringify({
                type: "call_reject",
                call_id: callId
            }));
        }

        function cancelCall() {
            if (currentCallId) {
                ws.send(JSON.stringify({
                    type: "call_reject",
                    call_id: currentCallId
                }));
                hideWaitingNotification();
            }
        }

        function handleCallAccepted(callId) {
            hideWaitingNotification();
            window.location.href = `/call/${callId}`;
        }

        function handleCallRejected(by) {
            hideWaitingNotification();
            alert(`${by} declined your call`);
        }

        function startAudioCall() {
            if (!currentContact) {
                alert("Please select a contact first");
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("Connection lost. Reconnecting...");
                connectWebSocket();
                return;
            }

            ws.send(JSON.stringify({
                type: "call_request",
                to: currentContact,
                is_audio_only: true
            }));

            showWaitingNotification(`${userId}_${currentContact}_${Date.now()}`);
        }

        function sendMessage() {
            const input = document.getElementById("message-input");
            const message = input.value.trim();

            if (!message) return;
            if (!currentContact) {
                alert("Please select a contact first");
                return;
            }
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("Connection lost. Reconnecting...");
                connectWebSocket();
                return;
            }

            try {
                ws.send(JSON.stringify({
                    type: "message",
                    to: currentContact,
                    message: message
                }));
                displayMessage(userId, message, false, new Date().toISOString());
                input.value = "";
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Failed to send message");
            }
        }

        function displayMessage(sender, message, isReceived, timestamp) {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${isReceived ? 'received' : 'sent'}`;

            const time = new Date(timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <strong>${sender}:</strong> ${message}
                <div class="timestamp">${time}</div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();

            document.getElementById("message-input").addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMessage();
            });
        });
    </script>
</body>
</html>
